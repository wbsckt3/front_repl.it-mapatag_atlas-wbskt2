<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mappi</title>
  <link href="style.css" rel="stylesheet" type="text/css" />
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>
     <!-- Agrega los scripts necesarios para Bootstrap y tu código JavaScript -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
  
  <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.1/dist/leaflet.css" integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.1/dist/leaflet.js" integrity="sha256-NDI0K41gVbWqfkkaHj15IzU7PtMoelkzyKp8TOaFQ3s=" crossorigin=""></script>

  <style>
     html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .leaflet-container {
      height: 400px;
      width: 600px;
      max-width: 100%;
      max-height: 100%;
    }
    #map {
      height: 100%;
      width: 100vw;
    }
     .container {
       width: 100%;
     }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #066445; /* Color de fondo del encabezado */
      color: #fff; /* Color del texto en el encabezado */
      padding: 10px;
      text-align: center;
    }

    nav {
      display: flex; /* Establecer el contenedor de navegación como un contenedor flex */
      justify-content: center; /* Centrar los elementos horizontalmente */
      background-color: #555; /* Color de fondo del menú */
    }

    nav ul {
      list-style: none; /* Eliminar los estilos de lista (viñetas) */
      margin: 0;
      padding: 0;
    }

    nav ul li {
      display: inline-block; /* Mostrar los elementos de lista en línea */
      margin-right: 10px; /* Espaciado entre elementos de lista */
    }

    nav ul li a {
      text-decoration: none; /* Eliminar la decoración de texto (subrayado) en los enlaces */
      color: #fff; /* Color del texto en los enlaces del menú */
    }
    .mb-3{
	    color: #ffffff
	    font-size: 20px;
    }
    h3{
       margin-top: 6px;
       font-weight: bold;
    }
    .container{
      margin-top: -25px;
    }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
	let usuario = "";
	let terceros = "";
	function handleCredentialResponse(response) {
           // decodeJwtResponse() is a custom function defined by you
           // to decode the credential response.
           const responsePayload = decodeJwtResponse(response.credential);
           console.log("ID: " + responsePayload.sub);
           console.log('Full Name: ' + responsePayload.name);
           console.log('Given Name: ' + responsePayload.given_name);
           console.log('Family Name: ' + responsePayload.family_name);
           console.log("Image URL: " + responsePayload.picture);
           console.log("Email: " + responsePayload.email);
	   localStorage.setItem("usuario", JSON.stringify(responsePayload.email));
  	   // Obtén el usuario almacenado en localStorage
           usuario = JSON.parse(localStorage.getItem("usuario"));
  	   // Verifica si el usuario existe antes de intentar mostrarlo
           if (usuario && responsePayload.email) {
        	// Actualiza el contenido del elemento h3 con el usuario
        	const h3Element = document.querySelector(".mb-3");
        	h3Element.textContent = `| Listado Pagos | Usuario: ${usuario}`;
        	// Muestra la tabla y oculta el botón de Google Sign-In
        	var tabla = document.querySelector(".table");
        	tabla.style.display = "block";
        	var gsignin = document.querySelector(".g_id_signin");
        	gsignin.style.display = "none";
        	// Llama a la función para obtener y mostrar los datos del tercero
        	obtenerYMostrarTerceros();
    	   }
        }
        function decodeJwtResponse(token) {
           var base64Url = token.split('.')[1];
           var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
           var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
              return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
           }).join(''));
           return JSON.parse(jsonPayload);
        }    
    </script>
</head>
<body>
  <header>
    <h3 >mappi</h3>
    <!-- <nav>
      <ul>
	<li><h4 class="mb-3"></h4></li>
      </ul> 
    </nav> -->
  </header>
	
  <div id="map"></div>
	
  <div id="g_id_onload"
     data-client_id="980822676255-vntch0t28qbesul2bp5oc1galtoi8a97.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-context="use"
     data-ux_mode="popup"
     data-auto_select="true"
     data-itp_support="true" style="padding: 20px;">
  </div>
  <div class="g_id_signin"
     data-type="standard"
     data-shape="rectangular"
     data-theme="outline"
     data-text="signin_with"
     data-size="large"
     data-logo_alignment="left" style="padding-left: 20px;">
  </div>
	
  <div class="container mt-5">

    <table class="table" style="display: none">
      <thead>
        <tr style="background: #a2baf4; font-size: 9px;">
         <th scope="col">FullName</th>
          <th scope="col">GivenName</th>
          <th scope="col">FamilyName</th>
          <th scope="col">Fecha Ingreso</th>
          <th scope="col">ImageURL</th>
          <th scope="col">Email</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody class="contenedor">
        <!-- Aquí se mostrarán los registros -->
      </tbody>
    </table>
  </div>
	
  <script>
   async function obtenerOneTercero() {
      usuario = JSON.parse(localStorage.getItem("usuario"));	   
      // const url = 'https://23913d9f-9a23-4b9c-9311-875072a4c064-00-3b5jrh193tc3d.kirk.replit.dev/getOneTercero/' + usuario;
      const url = 'https://23913d9f-9a23-4b9c-9311-875072a4c064-00-3b5jrh193tc3d.kirk.replit.dev/getOneGoogleSigninUser/' + usuario;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Error en la solicitud');
        }
        const data = await response.json();
        if (data && data.tercero) {
	   return data.tercero; // Devolver un array con el tercero
	} else {
	   throw new Error('No se encontró el tercero en los datos obtenidos');
	}
      } catch (error) {
        console.error('Error:', error);
        return [];
      }
    }

    //document.addEventListener("DOMContentLoaded", async () => {
   async function obtenerYMostrarTerceros() {
      terceros = await obtenerOneTercero();
      const contenedor = document.querySelector(".contenedor");
      let productosHTML = "";
      terceros.forEach((tercero) => {
        localStorage.setItem("usuario", JSON.stringify(tercero));
        productosHTML += `
          <tr style="border: 1px solid #80808078">
            <td>${GoogleSigninUser.FullName}</td>
            <td>${GoogleSigninUser.GivenName}</td>
            <td>${GoogleSigninUser.FamilyName}</td>
            <td>${GoogleSigninUser.FechaIngreso}</td>
            <td>${GoogleSigninUser.ImageURL}</td>
            <td>${GoogleSigninUser.Email}</td>
          </tr>
        `;
      });
      contenedor.innerHTML = productosHTML;
    //)};
    };
	  
  </script>
   
  <script>
    var greenIcon = L.icon({
        iconUrl: '/icon.png'
    });
    const options = {
        enableHighAccuracy: true,
        maximumAge: 1000, // 1s
        timeout: 2000 // 2s
    }
    var map= "";
    var tiles ="";
    var marker, circle, markerCameras;
    const socket = io();	
     
    navigator.geolocation.watchPosition(({coords}) => {
        lat = coords.latitude
        lon = coords.longitude
        map = L.map('map').setView([lat, lon], 17);
        tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 30, attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
         

    const timestamp = Date.now()
    if(localStorage.getItem('client') === null){ 
        insertObjectCoords(lat, lon, timestamp)
        localStorage.setItem('client', timestamp)
    } else {
        clientUniqueTimestampId =  localStorage.getItem('client')
        console.log(clientUniqueTimestampId)
        getSectorMarkers(lat,lon)
        socket.emit('load_init_emit', 'hola'); // e.latlng);
    }         
         

    //Loop through the markers array
    /*   for (var i=0; i<markers.length; i++) {
			
			var lo = markers[i][1];
			var la = markers[i][2];
				var popupText = markers[i][0]; 
				var markerLocation = new L.LatLng(la, lo);
				var markerCameras = new L.Marker(markerLocation);
				map.addLayer(markerCameras);
			 
				markerCameras.bindPopup(popupText);
			
         } */ 
        
         fun(lat, lon)
     }, console.error, options);
     
    var fun = function (la, lo) {
    function onLocationFound(e) {
          var radius = e.accuracy / 2;
          if (marker) { // check
             map.removeLayer(marker); // remove
          }
          // marker = L.marker(e.latlng).addTo(map);

          marker = L.marker(e.latlng, {icon: greenIcon}).addTo(map);
      }
      map.on('locationfound', onLocationFound);
      map.locate({setView: true, watch: true, maxZoom: 17});
    }

    // al momento de ingreasr el usuario se ingresa a object_coords y es cargado en get sector
    // junto con otro usuario activo que haya entrado
    var insertObjectCoords = function(la, lo, clientUniqueTimestampId){
	    $.ajax({
	      url: 'https://www.refactorii.com/insertparking',
	      method : 'POST',
	      data: {"user_lat":la, "user_lon":lo, "state": clientUniqueTimestampId},
	      success : function(data){ 
		ciudad = data
	      }, error: function(err){console.log('Failed');} 
	    });
     }
 
     var getSectorMarkers = function(la, lo){
	    // para hacer broadcast con socket.io a todos del punto actualizado
            // socket.emit( 'load_init_emit', {"user_lat":la, "user_lon":lo, "clientUniqueTimestampId": clientUniqueTimestampId} ); 	
	   $.ajax({
	      url: 'https://www.refactorii.com/getsector',
	      method : 'POST',
	      data: {"user_lat":la, "user_lon":lo,},
	      success : function(data){
                console.log(data)
                data.forEach(function(marker) {
                  L.marker([marker.latitude, marker.longitude]).addTo(map);
                });
	      }, error: function(err){console.log('Failed');} 
           });
     }

     socket.on('load_init_on', function(msg){
            console.log(msg);
     });
  </script>
	
</body>
</html>
