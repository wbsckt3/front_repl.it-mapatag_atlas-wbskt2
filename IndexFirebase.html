<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Sign-In</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>mappi</h1>
  </header>
</div>
<div class="content">    
    <p><h2>Sistema de Georreferenciación en tiempo real</h2></p>
</div>
<div class="content">    
    <p><h4>Ingresa con tu cuenta de Google</h4></p>
</div>
<div class="content">        
    <div id="g_id_onload"
     data-client_id="980822676255-vntch0t28qbesul2bp5oc1galtoi8a97.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-context="use"
     data-ux_mode="popup"
     data-auto_select="true"
     data-itp_support="true">
    </div>
    <div class="g_id_signin"
     data-type="standard"
     data-shape="rectangular"
     data-theme="outline"
     data-text="signin_with"
     data-size="large"
     data-logo_alignment="left">
    </div>
</div>
<div class="content"> ---
</div>
</div>  
<footer>
    <!-- Contenido del pie de página -->
   Powered by Refactorii@2024
</footer>

<script>
function handleCredentialResponse(response) {
    const responsePayload = decodeJwtResponse(response.credential);
    const email = responsePayload.email;
    getUserByEmail(email);
}

function decodeJwtResponse(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

async function getUserByEmail(email) {
    try {
    const response = await fetch(`https://maxsat.firebaseio.com/GoogleSigninUser.json`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
        },
    });
    if (!response.ok) {
        throw new Error('Error en la solicitud');
    }
    const data = await response.json();  

    // Convertir el objeto mapa a una lista de objetos
    const userList = Object.keys(data).map(key => ({
        id: key, // asignar el identificador único como una nueva propiedad
        ...data[key] // copiar los datos del objeto original
    }));

    console.log(userList); // Lista de usuarios con identificadores únicos
} catch (error) {
    console.error('Error al obtener los usuarios:', error);
}

}

async function agregarNuevoRegistro(registro){
    try {
        const response = await fetch('https://maxsat.firebaseio.com/GoogleSigninUser.json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(registro),
        });
        if (!response.ok) {
            throw new Error('Error en la solicitud');
        }
        const data = await response.json();
        return data.name; // El ID del nuevo registro generado por Firebase
    } catch (error) {
        console.error('Error:', error);
        return null;
    }
}

</script>
</body>
</html>
