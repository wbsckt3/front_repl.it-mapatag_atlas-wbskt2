<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Google Sign-In</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jwt-decode/3.1.2/jwt-decode.min.js"></script>
</head>
<body>
<div class="container">
  <header>
    <h1>mappi</h1>
  </header>
</div>
<div class="content">    
    <p><h2>Sistema de Georreferenciación en tiempo real</h2></p>
</div>
<div class="content">    
    <p><h4>Ingresa con tu cuenta de Google</h4></p>
</div>
<div class="content">        
    <div id="g_id_onload"
     data-client_id="980822676255-vntch0t28qbesul2bp5oc1galtoi8a97.apps.googleusercontent.com"
     data-callback="handleCredentialResponse"
     data-context="use"
     data-ux_mode="popup"
     data-auto_select="true"
     data-itp_support="true">
    </div>
    <div class="g_id_signin"
     data-type="standard"
     data-shape="rectangular"
     data-theme="outline"
     data-text="signin_with"
     data-size="large"
     data-logo_alignment="left">
    </div>
</div>
<div class="content"> ---
</div>
</div>  
<footer>
    <!-- Contenido del pie de página -->
   Powered by Refactorii@2024
</footer>

<script>
function handleCredentialResponse(response) {
    // to decode the credential response.
    // decodeJwtResponse() is a custom function defined by you
    const responsePayload = decodeJwtResponse(response.credential);
    console.log("ID: " + responsePayload.sub);
    console.log('Full Name: ' + responsePayload.name);
    console.log('Given Name: ' + responsePayload.given_name);
    console.log('Family Name: ' + responsePayload.family_name);
    console.log("Image URL: " + responsePayload.picture);
    console.log("Email: " + responsePayload.email);
    const email = responsePayload.email;
    getUserByEmail(email);
    const FullName = responsePayload.name;
	  const GivenName = responsePayload.given_name;
	  const FamilyName = responsePayload.family_name;
    const timestampHoy = new Date().getTime();
    const fechaHoy = new Date(timestampHoy);
    const year = '1970';
    const month = '01';
    const day = '01';
    const FechaIngreso = `${year}-${month}-${day}`;	   
    const ImageURL = responsePayload.picture;
	  const Email = responsePayload.email;
	  const formData = {
	      FullName,
	      GivenName,
	      FamilyName,
	      FechaIngreso,
	      ImageURL,
	      Email
	   };
           localStorage.setItem("formData", JSON.stringify(formData));     
}

function decodeJwtResponse(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

/* OK
  async function getUserByEmail(email) {
  
      try {
      const response = await fetch(`https://maxsat.firebaseio.com/GoogleSigninUser.json`, {
          method: 'GET',
          headers: {
              'Content-Type': 'application/json',
          },
      });
      if (!response.ok) {
          throw new Error('Error en la solicitud');
      }
      const data = await response.json();  
  
      // Convertir el objeto mapa a una lista de objetos
      const userList = Object.keys(data).map(key => ({
          id: key, // asignar el identificador único como una nueva propiedad
          ...data[key] // copiar los datos del objeto original
      }));
  
      console.log(userList); // Lista de usuarios con identificadores únicos
  } catch (error) {
      console.error('Error al obtener los usuarios:', error);
  }

} */

  async function getUserByEmail(email) {
    try {
        const response = await fetch(`https://maxsat.firebaseio.com/GoogleSigninUser.json`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        });
        if (!response.ok) {
            throw new Error('Error en la solicitud');
        }
        const data = await response.json();

        // Verificar si el usuario con el correo electrónico dado existe en la base de datos
        const existingUser = Object.values(data).find(user => user.Email === email);
        if (existingUser) {
            // Si el usuario existe, devolver la lista completa de usuarios
            const userList = Object.keys(data).map(key => ({
                id: key,
                ...data[key]
            }));
            console.log(userList);
            return userList;
        } else {
            // Si el usuario no existe, agregar un nuevo registro
            const formData = JSON.parse(localStorage.getItem("formData"));
            const nuevoRegistro = await agregarNuevoRegistro(formData);
            if (nuevoRegistro) {
              console.log('Registro creado exitosamente:', nuevoRegistro);
              //window.location.href = 'https://wbsckt3.github.io/front_REPLIT-mapatag_ATLAS-wbskt2/map.html';
            } else {
              console.error('Error al crear el registro.');
            }
            return null;
        }
    } catch (error) {
        console.error('Error al obtener los usuarios:', error);
        return null;
    }
}

async function agregarNuevoRegistro(registro){
    try {
        const response = await fetch('https://maxsat.firebaseio.com/GoogleSigninUser.json', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(registro),
        });
        if (!response.ok) {
            throw new Error('Error en la solicitud');
        }
        const data = await response.json();
        return data.name; // El ID del nuevo registro generado por Firebase
    } catch (error) {
        console.error('Error:', error);
        return null;
    }
}

</script>
</body>
</html>
